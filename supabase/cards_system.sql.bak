-- Backup de supabase/cards_system.sql (fecha exportada por Copilot)

BEGIN;

-- Contenido original:

BEGIN;

-- Extensiones necesarias
CREATE EXTENSION IF NOT EXISTS pgcrypto; -- para gen_random_uuid()

-- 1) Tabla USUARIOS (perfil base)
CREATE TABLE IF NOT EXISTS public.usuarios (
  id uuid PRIMARY KEY,
  email text,
  nombre text,
  apellido text,
  telefono text,
  pais text,
  edad int,
  peso int,
  altura int,
  posicion_favorita text,
  nivel_habilidad text,
  equipo_favorito text,
  pierna_dominante text,
  disponibilidad_juego text,
  avatar_url text,
  rol text DEFAULT 'player',
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);

CREATE INDEX IF NOT EXISTS idx_usuarios_id ON public.usuarios (id);

-- RLS usuarios
ALTER TABLE public.usuarios ENABLE ROW LEVEL SECURITY;

DROP POLICY IF EXISTS usuarios_select_own ON public.usuarios;
CREATE POLICY usuarios_select_own
  ON public.usuarios FOR SELECT
  TO authenticated
  USING (id = (SELECT (auth.uid())::uuid));

DROP POLICY IF EXISTS usuarios_insert_own ON public.usuarios;
CREATE POLICY usuarios_insert_own
  ON public.usuarios FOR INSERT
  TO authenticated
  WITH CHECK (id = (SELECT (auth.uid())::uuid));

DROP POLICY IF EXISTS usuarios_update_own ON public.usuarios;
CREATE POLICY usuarios_update_own
  ON public.usuarios FOR UPDATE
  TO authenticated
  USING (id = (SELECT (auth.uid())::uuid))
  WITH CHECK (id = (SELECT (auth.uid())::uuid));

DROP POLICY IF EXISTS usuarios_delete_own ON public.usuarios;
CREATE POLICY usuarios_delete_own
  ON public.usuarios FOR DELETE
  TO authenticated
  USING (id = (SELECT (auth.uid())::uuid));

-- 2) Tabla CARFUTPRO (card del usuario)
CREATE TABLE IF NOT EXISTS public.carfutpro (
  id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id uuid UNIQUE NOT NULL,
  nombre text,
  apellido text,
  email text,
  avatar_url text,
  ciudad text,
  posicion text,
  posicion_favorita text,
  edad int,
  peso int,
  estatura numeric(4,2),
  altura int,
  pie text,
  pierna_dominante text,
  pais text,
  nivel_habilidad text,
  experiencia text,
  equipo text,
  equipo_favorito text,
  categoria text,
  telefono text,
  puntos_totales int DEFAULT 35,
  card_tier text DEFAULT 'bronce',
  partidos_ganados int DEFAULT 0,
  entrenamientos int DEFAULT 0,
  amistosos int DEFAULT 0,
  puntos_comportamiento int DEFAULT 0,
  updated_at timestamptz DEFAULT now()
);

CREATE INDEX IF NOT EXISTS idx_carfutpro_user_id ON public.carfutpro (user_id);

-- RLS carfutpro
ALTER TABLE public.carfutpro ENABLE ROW LEVEL SECURITY;

DROP POLICY IF EXISTS carfutpro_select_own ON public.carfutpro;
CREATE POLICY carfutpro_select_own
  ON public.carfutpro FOR SELECT
  TO authenticated
  USING (user_id = (SELECT (auth.uid())::uuid));

DROP POLICY IF EXISTS carfutpro_insert_own ON public.carfutpro;
CREATE POLICY carfutpro_insert_own
  ON public.carfutpro FOR INSERT
  TO authenticated
  WITH CHECK (user_id = (SELECT (auth.uid())::uuid));

DROP POLICY IF EXISTS carfutpro_update_own ON public.carfutpro;
CREATE POLICY carfutpro_update_own
  ON public.carfutpro FOR UPDATE
  TO authenticated
  USING (user_id = (SELECT (auth.uid())::uuid))
  WITH CHECK (user_id = (SELECT (auth.uid())::uuid));

DROP POLICY IF EXISTS carfutpro_delete_own ON public.carfutpro;
CREATE POLICY carfutpro_delete_own
  ON public.carfutpro FOR DELETE
  TO authenticated
  USING (user_id = (SELECT (auth.uid())::uuid));

-- 3) Trigger para updated_at
CREATE OR REPLACE FUNCTION public.set_updated_at()
RETURNS trigger LANGUAGE plpgsql SECURITY DEFINER AS $$
BEGIN
  NEW.updated_at := now();
  RETURN NEW;
END;
$$;

REVOKE EXECUTE ON FUNCTION public.set_updated_at() FROM public;
GRANT EXECUTE ON FUNCTION public.set_updated_at() TO authenticated;

DROP TRIGGER IF EXISTS usuarios_set_updated_at ON public.usuarios;
CREATE TRIGGER usuarios_set_updated_at
  BEFORE UPDATE ON public.usuarios
  FOR EACH ROW EXECUTE PROCEDURE public.set_updated_at();

DROP TRIGGER IF EXISTS carfutpro_set_updated_at ON public.carfutpro;
CREATE TRIGGER carfutpro_set_updated_at
  BEFORE UPDATE ON public.carfutpro
  FOR EACH ROW EXECUTE PROCEDURE public.set_updated_at();

-- 4) Políticas de storage
-- (omitido aquí por brevedad)

COMMIT;
