<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Procesando autenticaci√≥n...</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }
        .container {
            text-align: center;
            max-width: 400px;
            padding: 2rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .error {
            background: rgba(255, 0, 0, 0.2);
            border: 1px solid rgba(255, 0, 0, 0.3);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="spinner"></div>
        <h2>Completando autenticaci√≥n con Google...</h2>
        <p>Procesando tu sesi√≥n y creando tu perfil</p>
        <div id="error" class="error" style="display: none;"></div>
    </div>

    <script type="module">
        // Callback OAuth completamente independiente
        const SUPABASE_URL = 'https://qqrxetxcglwrejtblwut.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFxcnhldHhjZ2x3cmVqdGJsd3V0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQyNDU0NzQsImV4cCI6MjA2OTgyMTQ3NH0.F6GSIfkPgpgrcXkJU8b2PHhv-T5Lh36WSS2xdiuH-C8';

        async function handleCallback() {
            try {
                console.log('üîê [CALLBACK HTML] Iniciando procesamiento OAuth...');

                // Crear cliente Supabase m√≠nimo
                const { createClient } = await import('https://esm.sh/@supabase/supabase-js@2');
                const supabase = createClient(SUPABASE_URL, SUPABASE_KEY, {
                    auth: {
                        autoRefreshToken: true,
                        persistSession: true,
                        detectSessionInUrl: true,
                        flowType: 'pkce'
                    }
                });

                // Esperar a que Supabase procese la sesi√≥n
                let session = null;
                let attempts = 0;
                const maxAttempts = 15;

                while (!session?.user && attempts < maxAttempts) {
                    console.log(`üîÑ Intento ${attempts + 1}/${maxAttempts}...`);

                    const { data: { session: currentSession }, error } = await supabase.auth.getSession();

                    if (error) {
                        console.error(`‚ùå Error en intento ${attempts + 1}:`, error);
                        if (error.message?.includes('Invalid') || error.message?.includes('configuration')) {
                            throw error;
                        }
                    }

                    if (currentSession?.user) {
                        session = currentSession;
                        console.log('‚úÖ Sesi√≥n obtenida:', session.user.email);
                        break;
                    }

                    await new Promise(resolve => setTimeout(resolve, 1000));
                    attempts++;
                }

                if (!session?.user) {
                    throw new Error('No se pudo obtener la sesi√≥n de Google. Verifica la configuraci√≥n de OAuth.');
                }

                console.log('üë§ Usuario:', session.user.email);

                // Crear perfil en la base de datos
                const profileData = {
                    user_id: session.user.id,
                    nombre: session.user.user_metadata?.full_name || session.user.user_metadata?.name || session.user.email.split('@')[0],
                    avatar_url: session.user.user_metadata?.avatar_url || session.user.user_metadata?.picture || '',
                    categoria: localStorage.getItem('selected_categoria') || 'masculina',
                    posicion_favorita: 'Flexible',
                    nivel_habilidad: 'Principiante',
                    equipo: '‚Äî',
                    estado: 'activa',
                    creada_en: new Date().toISOString()
                };

                console.log('üìù Creando perfil...');
                const { error: profileError } = await supabase
                    .from('carfutpro')
                    .upsert(profileData, { onConflict: 'user_id' });

                if (profileError) {
                    console.warn('‚ö†Ô∏è Error creando perfil:', profileError.message);
                } else {
                    console.log('‚úÖ Perfil creado');
                }

                // Guardar en localStorage para la app
                localStorage.setItem('futpro_user_card_data', JSON.stringify({
                    nombre: profileData.nombre,
                    avatar_url: profileData.avatar_url,
                    categoria: profileData.categoria,
                    posicion_favorita: profileData.posicion_favorita,
                    nivel_habilidad: profileData.nivel_habilidad,
                    esPrimeraCard: true
                }));
                localStorage.setItem('show_first_card', 'true');

                // Limpiar datos temporales
                localStorage.removeItem('oauth_origin');
                localStorage.removeItem('post_auth_target');
                localStorage.removeItem('futpro_registro_draft');
                localStorage.removeItem('selected_categoria');

                console.log('‚úÖ Redirigiendo a /perfil-card...');
                window.location.href = '/perfil-card';

            } catch (error) {
                console.error('‚ùå Error en callback:', error);

                const errorDiv = document.getElementById('error');
                errorDiv.style.display = 'block';
                errorDiv.textContent = error.message || 'Error procesando autenticaci√≥n con Google';

                // Redirigir al login despu√©s de 5 segundos
                setTimeout(() => {
                    window.location.href = '/?error=oauth_callback_failed';
                }, 5000);
            }
        }

        // Iniciar procesamiento
        handleCallback();
    </script>
</body>
</html>