<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç Diagn√≥stico OAuth - FutPro</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            color: #fff;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: #222;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(255, 215, 0, 0.2);
            border: 2px solid #FFD700;
        }
        h1 {
            color: #FFD700;
            margin-bottom: 10px;
            font-size: 32px;
        }
        .subtitle {
            color: #aaa;
            margin-bottom: 30px;
            font-size: 14px;
        }
        .section {
            background: #2a2a2a;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #FFD700;
        }
        .section h2 {
            color: #FFD700;
            margin-bottom: 15px;
            font-size: 20px;
        }
        .check-item {
            display: flex;
            align-items: flex-start;
            padding: 12px;
            background: #333;
            border-radius: 6px;
            margin-bottom: 10px;
        }
        .check-item input[type="checkbox"] {
            margin-right: 12px;
            margin-top: 4px;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        .check-item label {
            cursor: pointer;
            flex: 1;
        }
        .code-block {
            background: #1a1a1a;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            color: #0f0;
            margin: 10px 0;
            overflow-x: auto;
            border: 1px solid #444;
        }
        .warning {
            background: #441a00;
            border-left: 4px solid #ff6b00;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
        }
        .success {
            background: #1a4400;
            border-left: 4px solid #00ff6b;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
        }
        .btn {
            background: #FFD700;
            color: #000;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-right: 10px;
            margin-top: 10px;
        }
        .btn:hover {
            background: #ffc700;
        }
        .btn-secondary {
            background: #444;
            color: #fff;
        }
        .btn-secondary:hover {
            background: #555;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 6px;
            background: #2a2a2a;
            display: none;
        }
        .result.show {
            display: block;
        }
        .copy-btn {
            background: #555;
            color: #fff;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            float: right;
        }
        .copy-btn:hover {
            background: #666;
        }
        .progress {
            color: #FFD700;
            font-weight: bold;
            margin-top: 20px;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Diagn√≥stico OAuth - Google + Supabase</h1>
        <p class="subtitle">Herramienta de diagn√≥stico para resolver "Unable to exchange external code"</p>

        <!-- Secci√≥n 1: Configuraci√≥n Actual -->
        <div class="section">
            <h2>üìã 1. Verificar Configuraci√≥n Actual</h2>
            <button class="btn" onclick="checkCurrentConfig()">üîç Verificar URLs y Entorno</button>
            <div id="config-result" class="result"></div>
        </div>

        <!-- Secci√≥n 2: Checklist Google Cloud -->
        <div class="section">
            <h2>‚òÅÔ∏è 2. Google Cloud Console</h2>
            <p style="margin-bottom: 15px; color: #aaa;">Abre: <a href="https://console.cloud.google.com/apis/credentials" target="_blank" style="color: #FFD700;">Google Cloud Credentials</a></p>
            
            <div class="check-item">
                <input type="checkbox" id="check-google-1">
                <label for="check-google-1">
                    <strong>Authorized redirect URIs</strong> contiene EXACTAMENTE:
                    <div class="code-block">https://qqrxetxcglwrejtblwut.supabase.co/auth/v1/callback</div>
                    (sin espacios, sin barras extra, sin otros URIs mezclados)
                </label>
            </div>

            <div class="check-item">
                <input type="checkbox" id="check-google-2">
                <label for="check-google-2">
                    <strong>NO</strong> incluiste <code>https://futpro.vip/auth/callback</code> en los redirect URIs de Google (ese va solo en Supabase)
                </label>
            </div>

            <div class="check-item">
                <input type="checkbox" id="check-google-3">
                <label for="check-google-3">
                    <strong>OAuth Consent Screen</strong> ‚Üí Si est√° en "Testing", agregaste tu email como Test user
                </label>
            </div>

            <div class="check-item">
                <input type="checkbox" id="check-google-4">
                <label for="check-google-4">
                    Esperaste al menos <strong>2 minutos</strong> despu√©s de guardar cambios en Google
                </label>
            </div>
        </div>

        <!-- Secci√≥n 3: Checklist Supabase -->
        <div class="section">
            <h2>üóÑÔ∏è 3. Supabase Dashboard</h2>
            <p style="margin-bottom: 15px; color: #aaa;">Abre: <a href="https://supabase.com/dashboard/project/qqrxetxcglwrejtblwut/auth/providers" target="_blank" style="color: #FFD700;">Supabase Auth Providers</a></p>
            
            <div class="check-item">
                <input type="checkbox" id="check-supabase-1">
                <label for="check-supabase-1">
                    <strong>Google Provider Enabled:</strong> ‚úÖ marcado
                </label>
            </div>

            <div class="check-item">
                <input type="checkbox" id="check-supabase-2">
                <label for="check-supabase-2">
                    <strong>Client ID y Client Secret</strong> copiados exactamente desde Google (sin espacios ni saltos de l√≠nea)
                </label>
            </div>

            <div class="check-item">
                <input type="checkbox" id="check-supabase-3">
                <label for="check-supabase-3">
                    <strong>URL Configuration</strong> ‚Üí Site URL = <code>https://futpro.vip</code>
                </label>
            </div>

            <div class="check-item">
                <input type="checkbox" id="check-supabase-4">
                <label for="check-supabase-4">
                    <strong>Redirect URLs</strong> incluye:
                    <div class="code-block">https://futpro.vip/auth/callback
http://localhost:5173/auth/callback</div>
                </label>
            </div>
        </div>

        <!-- Secci√≥n 4: Test en Vivo -->
        <div class="section">
            <h2>üß™ 4. Probar OAuth Flow</h2>
            <button class="btn" onclick="clearAndTest()">üßπ Limpiar Storage y Probar</button>
            <button class="btn btn-secondary" onclick="testOAuthDirect()">üöÄ Ir a Login</button>
            <div id="test-result" class="result"></div>
        </div>

        <!-- Secci√≥n 5: Ver Logs -->
        <div class="section">
            <h2>üìä 5. Capturar Logs de Error</h2>
            <button class="btn" onclick="captureNetworkLogs()">üì° Ver Requests del Callback</button>
            <button class="btn btn-secondary" onclick="copyLogs()">üìã Copiar Logs Completos</button>
            <div id="logs-result" class="result"></div>
        </div>

        <!-- Progreso -->
        <div class="progress" id="progress">
            <span id="progress-count">0</span>/8 checks completados
        </div>
    </div>

    <script>
        // Funci√≥n para verificar configuraci√≥n actual
        function checkCurrentConfig() {
            const result = document.getElementById('config-result');
            result.classList.add('show');
            
            const hostname = window.location.hostname;
            const protocol = window.location.protocol;
            const origin = window.location.origin;
            const isProduction = hostname === 'futpro.vip';
            const baseUrl = isProduction ? 'https://futpro.vip' : origin;
            const oauthCallbackUrl = `${baseUrl}/auth/callback`;
            const supabaseUrl = 'https://qqrxetxcglwrejtblwut.supabase.co';
            const supabaseCallbackUrl = `${supabaseUrl}/auth/v1/callback`;
            
            result.innerHTML = `
                <div class="success">
                    <h3>‚úÖ Configuraci√≥n Detectada:</h3>
                    <ul style="margin-top: 10px; line-height: 1.8;">
                        <li><strong>Hostname:</strong> ${hostname}</li>
                        <li><strong>Protocolo:</strong> ${protocol}</li>
                        <li><strong>Entorno:</strong> ${isProduction ? 'üåê Producci√≥n' : 'üíª Desarrollo'}</li>
                        <li><strong>Base URL:</strong> <code>${baseUrl}</code></li>
                        <li><strong>OAuth Callback (App):</strong> <code>${oauthCallbackUrl}</code></li>
                        <li><strong>Supabase Callback (Google):</strong> <code>${supabaseCallbackUrl}</code></li>
                    </ul>
                </div>
                <div class="warning" style="margin-top: 15px;">
                    <strong>üî• IMPORTANTE:</strong><br>
                    Google debe tener: <code>${supabaseCallbackUrl}</code><br>
                    Supabase debe tener: <code>${oauthCallbackUrl}</code>
                </div>
            `;
        }

        // Funci√≥n para limpiar storage y probar
        function clearAndTest() {
            const result = document.getElementById('test-result');
            result.classList.add('show');
            
            try {
                localStorage.clear();
                sessionStorage.clear();
                
                // Limpiar cookies
                document.cookie.split(";").forEach(function(c) { 
                    document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
                });
                
                result.innerHTML = `
                    <div class="success">
                        ‚úÖ Storage limpiado correctamente<br>
                        ‚úÖ Cookies borradas<br>
                        üîÑ Recargando en 2 segundos...
                    </div>
                `;
                
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            } catch (e) {
                result.innerHTML = `
                    <div class="warning">
                        ‚ùå Error al limpiar: ${e.message}
                    </div>
                `;
            }
        }

        // Funci√≥n para ir directo al login
        function testOAuthDirect() {
            const isProduction = window.location.hostname === 'futpro.vip';
            const loginUrl = isProduction ? 'https://futpro.vip/' : window.location.origin + '/';
            window.location.href = loginUrl;
        }

        // Funci√≥n para capturar logs del Network tab
        function captureNetworkLogs() {
            const result = document.getElementById('logs-result');
            result.classList.add('show');
            
            result.innerHTML = `
                <div class="warning">
                    <h3>üì° Instrucciones para capturar logs:</h3>
                    <ol style="margin-top: 10px; line-height: 1.8; margin-left: 20px;">
                        <li>Abre DevTools (F12)</li>
                        <li>Ve a la pesta√±a <strong>Network</strong></li>
                        <li>Filtra por: <code>callback</code></li>
                        <li>Haz click en "Continuar con Google"</li>
                        <li>Completa el flujo OAuth</li>
                        <li>Busca la llamada a <code>/auth/v1/callback</code></li>
                        <li>Click derecho ‚Üí Copy ‚Üí Copy Response</li>
                        <li>P√©galo aqu√≠ abajo üëá</li>
                    </ol>
                </div>
                <textarea id="network-logs" style="width: 100%; height: 200px; margin-top: 15px; padding: 10px; background: #1a1a1a; color: #0f0; border: 1px solid #444; border-radius: 6px; font-family: 'Courier New', monospace;" placeholder="Pega aqu√≠ la respuesta del Network tab..."></textarea>
                <button class="btn" onclick="analyzeLogs()" style="margin-top: 10px;">üîç Analizar Logs</button>
                <div id="analysis-result" style="margin-top: 15px;"></div>
            `;
        }

        // Funci√≥n para analizar logs
        function analyzeLogs() {
            const logs = document.getElementById('network-logs').value;
            const analysisResult = document.getElementById('analysis-result');
            
            if (!logs.trim()) {
                analysisResult.innerHTML = `<div class="warning">‚ö†Ô∏è No hay logs para analizar</div>`;
                return;
            }
            
            try {
                const parsed = JSON.parse(logs);
                let diagnosis = '<div class="success"><h3>üîç An√°lisis:</h3><ul style="margin-top: 10px; line-height: 1.8; margin-left: 20px;">';
                
                if (parsed.error) {
                    diagnosis += `<li><strong>Error:</strong> ${parsed.error}</li>`;
                }
                if (parsed.error_description) {
                    diagnosis += `<li><strong>Descripci√≥n:</strong> ${parsed.error_description}</li>`;
                }
                if (parsed.message) {
                    diagnosis += `<li><strong>Mensaje:</strong> ${parsed.message}</li>`;
                }
                
                diagnosis += '</ul></div>';
                
                // Diagn√≥stico espec√≠fico
                if (parsed.error === 'redirect_uri_mismatch' || logs.includes('redirect_uri_mismatch')) {
                    diagnosis += `<div class="warning" style="margin-top: 15px;">
                        <strong>üö® REDIRECT URI MISMATCH</strong><br>
                        La URL que Supabase envi√≥ a Google NO coincide con las configuradas en Google Cloud Console.<br><br>
                        <strong>Soluci√≥n:</strong><br>
                        Ve a Google Cloud Console y aseg√∫rate de que los Authorized redirect URIs incluyan EXACTAMENTE:<br>
                        <code>https://qqrxetxcglwrejtblwut.supabase.co/auth/v1/callback</code>
                    </div>`;
                } else if (parsed.error === 'invalid_client' || logs.includes('invalid_client')) {
                    diagnosis += `<div class="warning" style="margin-top: 15px;">
                        <strong>üö® INVALID CLIENT</strong><br>
                        El Client ID o Client Secret est√°n incorrectos en Supabase.<br><br>
                        <strong>Soluci√≥n:</strong><br>
                        Copia de nuevo el Client ID y Client Secret desde Google Cloud Console a Supabase (sin espacios).
                    </div>`;
                } else if (logs.includes('Unable to exchange')) {
                    diagnosis += `<div class="warning" style="margin-top: 15px;">
                        <strong>üö® EXCHANGE ERROR</strong><br>
                        Supabase no puede canjear el c√≥digo de Google. Causas comunes:<br>
                        1. Redirect URI mismatch<br>
                        2. Client Secret incorrecto<br>
                        3. C√≥digo expirado (recargaste la p√°gina del callback)<br><br>
                        <strong>Soluci√≥n:</strong><br>
                        Verifica que TODOS los URIs coincidan exactamente y prueba en inc√≥gnito sin recargar.
                    </div>`;
                }
                
                analysisResult.innerHTML = diagnosis;
            } catch (e) {
                analysisResult.innerHTML = `<div class="warning">‚ö†Ô∏è No se pudo parsear como JSON. Texto raw:<br><pre style="margin-top: 10px; overflow-x: auto;">${logs}</pre></div>`;
            }
        }

        // Funci√≥n para copiar logs de consola
        function copyLogs() {
            const logs = `
=== DIAGN√ìSTICO OAUTH - FUTPRO ===
Fecha: ${new Date().toISOString()}
Hostname: ${window.location.hostname}
URL Completa: ${window.location.href}

=== CONFIGURACI√ìN ===
Base URL: ${window.location.origin}
OAuth Callback: ${window.location.origin}/auth/callback
Supabase URL: https://qqrxetxcglwrejtblwut.supabase.co

=== STORAGE ===
localStorage keys: ${Object.keys(localStorage).join(', ') || 'vac√≠o'}
sessionStorage keys: ${Object.keys(sessionStorage).join(', ') || 'vac√≠o'}

=== SIGUIENTE PASO ===
1. Abre la consola (F12)
2. Haz el flujo OAuth completo
3. Copia TODOS los mensajes de la consola
4. Env√≠a todo junto con este reporte
            `;
            
            navigator.clipboard.writeText(logs).then(() => {
                alert('‚úÖ Logs copiados al portapapeles');
            }).catch(err => {
                alert('‚ùå Error al copiar: ' + err);
            });
        }

        // Actualizar progreso
        function updateProgress() {
            const checkboxes = document.querySelectorAll('input[type="checkbox"]');
            const checked = document.querySelectorAll('input[type="checkbox"]:checked').length;
            document.getElementById('progress-count').textContent = checked;
            
            if (checked === checkboxes.length) {
                document.getElementById('progress').innerHTML = 'üéâ <strong>¬°Todos los checks completados! Prueba el OAuth ahora.</strong>';
                document.getElementById('progress').style.color = '#00ff6b';
            }
        }

        // Event listeners
        document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
            cb.addEventListener('change', updateProgress);
        });

        // Auto-verificar configuraci√≥n al cargar
        window.addEventListener('load', () => {
            checkCurrentConfig();
        });
    </script>
</body>
</html>
