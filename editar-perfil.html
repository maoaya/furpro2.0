<!DOCTYPE html>
<html lang="es">
<head>
	<meta charset="UTF-8">
	<title>Editar Perfil - FutPro</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
	<style>
		body { background: #181818; color: #FFD700; font-family: 'Segoe UI', Arial, sans-serif; }
		.container { max-width: 480px; margin: 48px auto; background: #232323; border-radius: 18px; box-shadow: 0 4px 24px #000a; padding: 32px; }
		h1 { color: #FFD700; text-align: center; margin-bottom: 32px; }
		label { color: #FFD700; font-weight: bold; margin-top: 18px; display: block; }
		input, select, textarea { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #FFD700; background: #181818; color: #FFD700; margin-bottom: 18px; font-size: 1rem; }
		button { background: #FFD700; color: #181818; border: none; border-radius: 8px; padding: 12px 0; font-weight: bold; width: 100%; font-size: 1.1rem; cursor: pointer; margin-top: 12px; }
		button:hover { background: #FFA500; }
		.avatar-preview { display: flex; align-items: center; gap: 18px; margin-bottom: 18px; }
		.avatar-preview img { width: 72px; height: 72px; border-radius: 50%; border: 2px solid #FFD700; object-fit: cover; background: #333; }
		.msg { color: #FFD700; text-align: center; margin-bottom: 18px; }
	</style>
</head>
<body>
	<div class="container">
		<h1>Editar Perfil</h1>
		<div class="avatar-preview">
			<img id="avatarImg" src="https://i.imgur.com/placeholder-user.jpg" alt="Avatar">
			<input type="file" id="avatarInput" accept="image/*">
		</div>
		<form id="perfilForm">
			<label for="nombre">Nombre</label>
			<input type="text" id="nombre" required>
			<label for="posicion">Posición</label>
			<select id="posicion">
				<option value="">Selecciona tu posición</option>
				<option>Portero</option>
				<option>Defensa</option>
				<option>Mediocampo</option>
				<option>Delantero</option>
			</select>
			<label for="equipo">Equipo</label>
			<input type="text" id="equipo">
			<label for="bio">Biografía</label>
			<textarea id="bio" rows="3" maxlength="120" placeholder="Cuéntanos algo sobre ti..."></textarea>
			<button type="submit">Guardar Cambios</button>
		</form>
		<div class="msg" id="msg"></div>
	</div>
	<script>
		// Sistema de auto-guardado para editar perfil
		class PerfilAutoSave {
			constructor() {
				this.userId = this.getCurrentUserId();
			}

			getCurrentUserId() {
				let user = JSON.parse(localStorage.getItem('futpro_user') || '{}');
				if (!user.id) {
					user.id = 'user_' + Date.now();
					localStorage.setItem('futpro_user', JSON.stringify(user));
				}
				return user.id;
			}

			save(categoria, data, accion = 'crear') {
				try {
					const registro = {
						id: Date.now() + Math.random(),
						userId: this.userId,
						accion: accion,
						timestamp: new Date().toISOString(),
						...data
					};

					const existing = JSON.parse(localStorage.getItem(`futpro_${categoria}`) || '[]');
					existing.push(registro);
					localStorage.setItem(`futpro_${categoria}`, JSON.stringify(existing));

					console.log(`✅ Auto-guardado: ${categoria} - ${accion}`, registro);
					return registro;
				} catch (error) {
					console.error('❌ Error en auto-guardado:', error);
					return null;
				}
			}
		}

		const autoSave = new PerfilAutoSave();

		// Cargar datos actuales
		const user = JSON.parse(localStorage.getItem('futpro_user') || '{}');
		document.getElementById('nombre').value = user.nombre || '';
		document.getElementById('posicion').value = user.posicion || '';
		document.getElementById('equipo').value = user.equipo || '';
		document.getElementById('bio').value = user.bio || '';
		if(user.avatar) document.getElementById('avatarImg').src = user.avatar;

		// AUTO-GUARDAR: Acceso a editar perfil
		autoSave.save('navegacion', {
			seccion: 'editar_perfil',
			usuario: user.nombre || 'Usuario sin nombre'
		}, 'acceder');

		// Cambiar avatar
		document.getElementById('avatarInput').addEventListener('change', function(e) {
			const file = e.target.files[0];
			if(file) {
				const reader = new FileReader();
				reader.onload = function(ev) {
					const avatarAnterior = document.getElementById('avatarImg').src;
					document.getElementById('avatarImg').src = ev.target.result;
					
					// AUTO-GUARDAR: Cambio de foto de perfil
					autoSave.save('cambios_perfil', {
						campo: 'avatar',
						valorAnterior: avatarAnterior,
						valorNuevo: ev.target.result.substring(0, 100) + '...',
						archivo: file.name,
						tamaño: file.size
					}, 'cambiar_foto');

					autoSave.save('fotos_subidas', {
						tipo: 'avatar',
						nombre: file.name,
						tamaño: file.size,
						descripcion: 'Foto de perfil actualizada'
					}, 'subir');
				};
				reader.readAsDataURL(file);
			}
		});

		// Guardar cambios
		document.getElementById('perfilForm').addEventListener('submit', function(e) {
			e.preventDefault();
			const nombre = document.getElementById('nombre').value.trim();
			const posicion = document.getElementById('posicion').value;
			const equipo = document.getElementById('equipo').value.trim();
			const bio = document.getElementById('bio').value.trim();
			const avatar = document.getElementById('avatarImg').src;
			
			if(!nombre) { 
				document.getElementById('msg').textContent = 'El nombre es obligatorio.'; 
				return; 
			}

			// Detectar cambios específicos
			const cambios = [];
			if (user.nombre !== nombre) cambios.push({campo: 'nombre', anterior: user.nombre, nuevo: nombre});
			if (user.posicion !== posicion) cambios.push({campo: 'posicion', anterior: user.posicion, nuevo: posicion});
			if (user.equipo !== equipo) cambios.push({campo: 'equipo', anterior: user.equipo, nuevo: equipo});
			if (user.bio !== bio) cambios.push({campo: 'bio', anterior: user.bio, nuevo: bio});

			const nuevo = { ...user, nombre, posicion, equipo, bio, avatar };
			localStorage.setItem('futpro_user', JSON.stringify(nuevo));

			// AUTO-GUARDAR: Cada cambio específico
			cambios.forEach(cambio => {
				autoSave.save('cambios_perfil', {
					campo: cambio.campo,
					valorAnterior: cambio.anterior || 'No definido',
					valorNuevo: cambio.nuevo || 'No definido'
				}, 'editar');
			});

			// AUTO-GUARDAR: Perfil completado/actualizado
			autoSave.save('user', nuevo, cambios.length > 0 ? 'actualizar' : 'completar');

			document.getElementById('msg').textContent = '¡Perfil actualizado!';
			setTimeout(()=>{ window.location.href = './perfil-instagram.html'; }, 1200);
		});
	</script>
</body>
</html>