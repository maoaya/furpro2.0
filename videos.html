<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FutPro - Videos</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    body { font-family: Segoe UI, Tahoma, Verdana; background: #0f0f0f; color: #fff; margin: 0; }
    .tiktok-container { width: 100vw; height: 100vh; overflow: hidden; position: relative; background: #111; }
    .tiktok-video { width: 100vw; height: 100vh; object-fit: cover; background: #000; }
    .tiktok-info { position: absolute; bottom: 80px; left: 24px; color: #FFD700; background: rgba(24,24,24,0.7); padding: 18px 22px; border-radius: 18px; max-width: 340px; box-shadow: 0 2px 12px #000a; }
    .tiktok-author { font-weight: bold; font-size: 1.1rem; margin-bottom: 6px; }
    .tiktok-desc { font-size: 1rem; margin-bottom: 8px; color: #fff; }
    .tiktok-date { font-size: 0.9rem; color: #ccc; }
    .tiktok-actions { position: absolute; right: 24px; bottom: 120px; display: flex; flex-direction: column; gap: 22px; align-items: center; }
    .tiktok-btn { background: rgba(0,0,0,0.5); border: none; color: #FFD700; font-size: 2.1rem; padding: 14px; border-radius: 50%; cursor: pointer; box-shadow: 0 2px 8px #000a; transition: background 0.2s; }
    .tiktok-btn.liked { color: #FF1744; }
    .tiktok-btn:active { background: #FFD70022; }
    .tiktok-count { font-size: 1rem; margin-top: 4px; color: #FFD700; }
    .tiktok-topbar { position: absolute; top: 0; left: 0; width: 100vw; height: 60px; background: rgba(24,24,24,0.95); border-bottom: 2px solid #FFD700; display: flex; align-items: center; justify-content: space-between; padding: 0 24px; z-index: 100; }
    .tiktok-topbar .logo { font-size: 2rem; font-weight: bold; color: #FFD700; }
    .tiktok-topbar .volver { color: #FFD700; background: none; border: none; font-size: 1.3rem; cursor: pointer; }
    @media (max-width: 600px) {
      .tiktok-info { left: 8px; right: 8px; max-width: 98vw; padding: 12px 10px; }
      .tiktok-actions { right: 8px; bottom: 80px; }
      .tiktok-topbar { padding: 0 8px; height: 48px; }
    }
  </style>
</head>
<body>
  <div class="tiktok-topbar">
    <button class="volver" onclick="window.location.href='./homepage-instagram.html'">← Volver</button>
    <div class="logo">⚽ FutPro</div>
    <button class="volver" onclick="abrirModalSubirVideo()">➕ Subir</button>
  </div>
  <div id="modalSubirVideo" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.92);z-index:10001;align-items:center;justify-content:center;"></div>
  <div class="tiktok-container" id="tiktokContainer">
    <video id="tiktokVideo" class="tiktok-video" autoplay muted playsinline></video>
    <div class="tiktok-info" id="tiktokInfo"></div>
    <div class="tiktok-actions">
      <button class="tiktok-btn" id="likeBtn" onclick="darLikeVideo()"><i class="fas fa-futbol"></i><div class="tiktok-count" id="likeCount">0</div></button>
      <button class="tiktok-btn" onclick="abrirComentarios()"><i class="fas fa-comment"></i></button>
      <button class="tiktok-btn" onclick="compartirVideo()"><i class="fas fa-share"></i></button>
    </div>
  </div>
  <div id="modalComentarios" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.92);z-index:10000;align-items:center;justify-content:center;"></div>

  <script>
    // Modal de subida de video
    function abrirModalSubirVideo() {
      const modal = document.getElementById('modalSubirVideo');
      modal.style.display = 'flex';
      modal.innerHTML = `
        <div style='background:#181818;padding:32px 24px 24px 24px;border-radius:22px;max-width:340px;width:96vw;box-shadow:0 8px 40px #000a;position:relative;'>
          <button onclick=\"cerrarModalSubirVideo()\" style=\"position:absolute;top:10px;right:10px;background:none;border:none;color:#FFD700;font-size:1.5rem;cursor:pointer;\"><i class='fas fa-times'></i></button>
          <h3 style='color:#FFD700;font-size:1.2rem;margin-bottom:18px;'>Subir Video</h3>
          <form id='formSubirVideo' style='display:flex;flex-direction:column;gap:10px;'>
            <input type='file' id='archivoVideo' accept='video/*' required style='background:#222;color:#FFD700;padding:8px;border-radius:8px;border:1px solid #FFD700;' />
            <input type='text' id='tituloVideo' maxlength='80' placeholder='Título del video' required style='background:#222;color:#FFD700;padding:8px;border-radius:8px;border:1px solid #FFD700;font-size:0.95rem;' />
            <input type='text' id='descripcionVideo' maxlength='120' placeholder='Descripción (opcional)' style='background:#222;color:#FFD700;padding:8px;border-radius:8px;border:1px solid #FFD700;font-size:0.95rem;' />
            <select id='categoriaVideo' style='background:#222;color:#FFD700;padding:8px;border-radius:8px;border:1px solid #FFD700;font-size:0.95rem;'>
              <option value='partido'>Partido</option>
              <option value='entrenamiento'>Entrenamiento</option>
              <option value='destacado'>Destacado</option>
            </select>
            <button type='submit' style='background:#FFD700;color:#181818;font-weight:bold;padding:8px 0;border:none;border-radius:12px;font-size:1.1rem;margin-top:8px;'>Subir</button>
          </form>
          <div id='msgSubida' style='color:#FFD700;margin-top:12px;font-weight:bold;'></div>
        </div>
      `;
      document.getElementById('formSubirVideo').onsubmit = subirVideoSupabase;
    }
    function cerrarModalSubirVideo() {
      document.getElementById('modalSubirVideo').style.display = 'none';
    }

    // Subida real a Supabase y Netlify
    async function subirVideoSupabase(e) {
      e.preventDefault();
      const archivo = document.getElementById('archivoVideo').files[0];
      const titulo = document.getElementById('tituloVideo').value;
      const descripcion = document.getElementById('descripcionVideo').value;
      const categoria = document.getElementById('categoriaVideo').value;
      const msg = document.getElementById('msgSubida');
      if (!archivo || !titulo) { msg.textContent = 'Completa todos los campos.'; return; }
      msg.textContent = 'Subiendo video...';
      let user = JSON.parse(localStorage.getItem('futpro_user') || '{}');
      let userId = user.id;
      try {
        // 1. Subir archivo a Supabase Storage
        let mediaUrl = '';
        if (window.storageOperations && userId) {
          mediaUrl = await window.storageOperations.uploadPostMedia(archivo, Date.now());
        }
        // 2. Crear post en Supabase
        let postData = {
          user_id: userId,
          media_url: mediaUrl,
          titulo: titulo,
          descripcion: descripcion,
          categoria: categoria,
          fecha: new Date().toISOString(),
          likes: [],
          comentarios: []
        };
        if (window.dbOperations) {
          await window.dbOperations.createPost(postData);
        }
        msg.textContent = '¡Video subido exitosamente!';
        setTimeout(() => { cerrarModalSubirVideo(); cargarVideosSupabase(); }, 1200);
      } catch (err) {
        msg.textContent = 'Error al subir el video.';
      }
    }
    // --- TikTok Experience con Supabase ---
    let videos = [];
    let currentIndex = 0;
    let userId = null;
    let followingIds = [];
    let loaded = false;

    // Cargar usuario actual
    try {
      const user = JSON.parse(localStorage.getItem('futpro_user') || '{}');
      userId = user.id;
    } catch {}

    // Función para cargar videos de seguidos y sugeridos (populares)
    async function cargarVideosSupabase() {
      loaded = false;
      // 1. Obtener seguidos
      followingIds = [];
      if (window.dbOperations && userId) {
        try {
          const seguidos = await window.dbOperations.getUserFollowing(userId);
          followingIds = seguidos.map(u => u.id);
        } catch {}
      }
      // 2. Obtener videos de seguidos
      let postsSeguidos = [];
      let postsPopulares = [];
      if (window.dbOperations) {
        try {
          if (followingIds.length > 0) {
            postsSeguidos = await window.dbOperations.getPosts(30, 0);
            postsSeguidos = postsSeguidos.filter(p => followingIds.includes(p.user.id));
          }
          // 3. Obtener videos populares (más likes)
          postsPopulares = await window.dbOperations.getPosts(30, 0);
          postsPopulares = postsPopulares.sort((a,b) => (b.likes?.length||0)-(a.likes?.length||0)).slice(0, 20);
        } catch {}
      }
      // 4. Unir y eliminar duplicados
      const ids = new Set();
      videos = [...postsSeguidos, ...postsPopulares].filter(v => {
        if (ids.has(v.id)) return false;
        ids.add(v.id); return true;
      });
      if (videos.length === 0) {
        // Fallback: datos locales
        videos = [
          {id:'1',media_url:'https://sample-videos.com/zip/10/mp4/mp4-360-426-sample.mp4',user:{name:'UEFA',avatar_url:''},descripcion:'Gol de la fecha',fecha:'2025-10-23',likes:[],comentarios:[]},
          {id:'2',media_url:'https://sample-videos.com/zip/10/mp4/mp4-640-360-sample.mp4',user:{name:'Coach Pro',avatar_url:''},descripcion:'Entrenamiento de velocidad',fecha:'2025-10-23',likes:[],comentarios:[]}
        ];
      }
      loaded = true;
      mostrarVideoActual();
    }

    // Mostrar video actual
    function mostrarVideoActual() {
      if (!loaded || videos.length === 0) return;
      const v = videos[currentIndex];
      const videoEl = document.getElementById('tiktokVideo');
      videoEl.src = v.media_url || v.url || '';
      videoEl.load();
      // Info
      document.getElementById('tiktokInfo').innerHTML = `
        <div class='tiktok-author'>${v.user?.name || 'Usuario'}</div>
        <div class='tiktok-desc'>${v.descripcion || v.titulo || ''}</div>
        <div class='tiktok-date'>${v.fecha || ''}</div>
      `;
      // Likes
      document.getElementById('likeCount').textContent = v.likes?.length || 0;
      document.getElementById('likeBtn').classList.toggle('liked', v.likes?.includes(userId));
    }

    // Navegación swipe/touch
    let touchStartY = 0;
    document.getElementById('tiktokContainer').addEventListener('touchstart', function(e) {
      touchStartY = e.touches[0].clientY;
    });
    document.getElementById('tiktokContainer').addEventListener('touchend', function(e) {
      const touchEndY = e.changedTouches[0].clientY;
      const diff = touchStartY - touchEndY;
      if (Math.abs(diff) > 50) {
        if (diff > 0) siguienteVideo();
        else anteriorVideo();
      }
    });
    // Navegación con teclado (desktop)
    document.addEventListener('keydown', function(e) {
      if (e.key === 'ArrowDown') siguienteVideo();
      if (e.key === 'ArrowUp') anteriorVideo();
    });

    function siguienteVideo() {
      if (!loaded || videos.length === 0) return;
      currentIndex = (currentIndex + 1) % videos.length;
      mostrarVideoActual();
    }
    function anteriorVideo() {
      if (!loaded || videos.length === 0) return;
      currentIndex = (currentIndex - 1 + videos.length) % videos.length;
      mostrarVideoActual();
    }

    // Like
    async function darLikeVideo() {
      if (!loaded || videos.length === 0) return;
      const v = videos[currentIndex];
      if (!v.likes) v.likes = [];
      if (v.likes.includes(userId)) return;
      v.likes.push(userId);
      document.getElementById('likeCount').textContent = v.likes.length;
      document.getElementById('likeBtn').classList.add('liked');
      // Guardar en Supabase
      if (window.dbOperations && v.id && userId) {
        try { await window.dbOperations.likePost(v.id, userId); } catch {}
      }
    }

    // Comentarios
    function abrirComentarios() {
      if (!loaded || videos.length === 0) return;
      const v = videos[currentIndex];
      const modal = document.getElementById('modalComentarios');
      modal.style.display = 'flex';
      let html = `<div style='background:#181818;padding:32px 24px 24px 24px;border-radius:22px;max-width:340px;width:96vw;box-shadow:0 8px 40px #000a;position:relative;'>`;
      html += `<button onclick="cerrarComentarios()" style="position:absolute;top:10px;right:10px;background:none;border:none;color:#FFD700;font-size:1.5rem;cursor:pointer;"><i class='fas fa-times'></i></button>`;
      html += `<h3 style='color:#FFD700;font-size:1.2rem;margin-bottom:18px;'>Comentarios</h3>`;
      html += `<div id='comentariosList' style='max-height:180px;overflow-y:auto;margin-bottom:12px;'>`;
      if (v.comentarios && v.comentarios.length > 0) {
        html += v.comentarios.map(c => `<div style='color:#FFD700;margin-bottom:8px;'><b>${c.user}</b>: ${c.texto}</div>`).join('');
      } else {
        html += `<div style='color:#888;'>Sin comentarios aún</div>`;
      }
      html += `</div>`;
      html += `<div style='display:flex;gap:8px;'><input id='inputComentario' type='text' maxlength='120' placeholder='Escribe un comentario...' style='flex:1;background:#222;color:#FFD700;padding:8px;border-radius:8px;border:1px solid #FFD700;font-size:0.97rem;'><button onclick="enviarComentario()" style='background:#FFD700;color:#181818;font-weight:bold;padding:7px 12px;border:none;border-radius:8px;font-size:1rem;cursor:pointer;'>Enviar</button></div>`;
      html += `</div>`;
      modal.innerHTML = html;
    }
    function cerrarComentarios() {
      document.getElementById('modalComentarios').style.display = 'none';
    }
    async function enviarComentario() {
      if (!loaded || videos.length === 0) return;
      const v = videos[currentIndex];
      const input = document.getElementById('inputComentario');
      const texto = input.value.trim();
      if (!texto) return;
      const user = JSON.parse(localStorage.getItem('futpro_user') || '{}');
      const nuevoComentario = { user: user.nombre || 'Anónimo', texto, fecha: new Date().toISOString() };
      if (!v.comentarios) v.comentarios = [];
      v.comentarios.push(nuevoComentario);
      // Guardar en Supabase
      if (window.dbOperations && v.id && userId) {
        try { await window.dbOperations.addComment({ post_id: v.id, user_id: userId, texto }); } catch {}
      }
      abrirComentarios();
    }

    // Compartir
    function compartirVideo() {
      if (!loaded || videos.length === 0) return;
      const v = videos[currentIndex];
      const url = window.location.origin + '/videos.html?video=' + v.id;
      if (navigator.clipboard) {
        navigator.clipboard.writeText(url).then(() => {
          alert('URL copiada al portapapeles');
        });
      } else {
        prompt('Copia esta URL para compartir:', url);
      }
    }

    // Subir video (modal simple)
    function subirVideo() {
      alert('Función de subida de video: implementa modal y conexión a Supabase.');
    }

    // Inicializar
    window.addEventListener('DOMContentLoaded', cargarVideosSupabase);
  </script>
</body>
</html>