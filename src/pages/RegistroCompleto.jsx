import React, { useState, useRef } from 'react';
import { useNavigate } from 'react-router-dom';
import supabase from '../supabaseClient';
import { useAuth } from '../context/AuthContext.jsx';

const RegistroCompleto = () => {
  const navigate = useNavigate();
  const fileInputRef = useRef(null);
  const { user } = useAuth();
  
  // Estado del formulario paso a paso
  const [paso, setPaso] = useState(1);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');
  const [success, setSuccess] = useState('');
  const [imagenPerfil, setImagenPerfil] = useState(null);
  const [previewImagen, setPreviewImagen] = useState(null);

  const [formData, setFormData] = useState({
    // Paso 1: Datos b√°sicos
    email: '',
    password: '',
    confirmPassword: '',
    
    // Paso 2: Informaci√≥n personal
    nombre: '',
    apellido: '',
    edad: 18,
    telefono: '',
    pais: 'M√©xico',
    ubicacion: '',
    
    // Paso 3: Informaci√≥n futbol√≠stica
    posicion: '',
    experiencia: '',
    equipoFavorito: '',
    peso: '',
    
    // Paso 4: Disponibilidad
    disponibilidad: '',
    vecesJuegaPorSemana: '',
    horariosPreferidos: '',
    
    // Paso 5: Foto de perfil
    foto: null
  });
  };

  const handleImageChange = (e) => {
    const file = e.target.files[0];
    if (file) {
      if (file.size > 5 * 1024 * 1024) {
        setError('La imagen debe ser menor a 5MB');
        return;
      }
      setForm({ ...form, avatar_url: file });
      const reader = new FileReader();
      reader.onload = (e) => setPreviewImage(e.target.result);
      reader.readAsDataURL(file);
    }
  };

  const uploadImage = async (file) => {
    try {
      const fileExt = file.name.split('.').pop();
      const fileName = `${Date.now()}.${fileExt}`;
      const filePath = `avatars/${fileName}`;

      const { error: uploadError } = await supabase.storage
        .from('avatars')
        .upload(filePath, file);

      if (uploadError) {
        console.warn('‚ö†Ô∏è Error subiendo imagen:', uploadError);
        return null;
      }

      const { data } = supabase.storage
        .from('avatars')
        .getPublicUrl(filePath);

      return data.publicUrl;
    } catch (error) {
      console.warn('‚ö†Ô∏è Error en upload:', error);
      return null;
    }
  };

  const nextStep = () => {
    if (currentStep === 1) {
      if (!form.nombre?.trim()) {
        setError('El nombre es obligatorio');
        return;
      }
      if (!form.email?.trim()) {
        setError('El email es obligatorio');
        return;
      }
      if (!form.password) {
        setError('La contrase√±a es obligatoria');
        return;
      }
      if (form.password !== form.confirmPassword) {
        setError('Las contrase√±as no coinciden');
        return;
      }
      if (form.password.length < 6) {
        setError('La contrase√±a debe tener al menos 6 caracteres');
        return;
      }
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(form.email)) {
        setError('Por favor ingresa un email v√°lido');
        return;
      }
    }

    if (currentStep === 2) {
      if (!form.posicion) {
        setError('La posici√≥n es obligatoria');
        return;
      }
      if (!form.frecuencia_juego) {
        setError('La frecuencia de juego es obligatoria');
        return;
      }
      if (form.edad < 13 || form.edad > 60) {
        setError('La edad debe estar entre 13 y 60 a√±os');
        return;
      }
      if (form.peso && (form.peso < 30 || form.peso > 150)) {
        setError('El peso debe estar entre 30 y 150 kg');
        return;
      }
    }
    
    setCurrentStep(currentStep + 1);
    setError('');
  };

  const prevStep = () => {
    setCurrentStep(currentStep - 1);
    setError('');
  };

  // Manejar OAuth despu√©s de completar los datos del formulario
  const handleOAuthComplete = async (provider) => {
    setLoading(true);
    setError('');
    
    try {
      // Validar que tenemos datos m√≠nimos del formulario
      if (!form.nombre?.trim()) {
        setError('Por favor completa al menos tu nombre antes de usar OAuth');
        setLoading(false);
        return;
      }

      // Guardar datos del formulario para completar despu√©s del OAuth
      const profileData = {
        nombre: form.nombre.trim(),
        edad: parseInt(form.edad) || null,
        peso: form.peso ? parseFloat(form.peso) : null,
        ciudad: form.ciudad?.trim() || null,
        pais: form.pais?.trim() || 'Espa√±a',
        posicion: form.posicion || 'Delantero Centro',
        frecuencia_juego: form.frecuencia_juego || '3',
        rol: form.rol,
        tipo_usuario: form.tipo_usuario
      };

      // Guardar en localStorage para completar despu√©s del OAuth
      localStorage.setItem('pendingProfileData', JSON.stringify(profileData));
      localStorage.setItem('postLoginRedirect', '/home');
      
      console.log('üìù Datos guardados para OAuth:', {
        profileData,
        redirect: '/home'
      });

      console.log(`üöÄ Iniciando OAuth con ${provider} desde registro completo`);
      setMsg(`Conectando con ${provider}...`);

      // Iniciar OAuth
      if (provider === 'google') {
        const result = await loginWithGoogle();
        if (result?.error) {
          setError(`Error con Google: ${result.error}`);
          setLoading(false);
        } else {
          console.log('‚úÖ OAuth Google iniciado correctamente');
        }
      } else if (provider === 'facebook') {
        const result = await loginWithFacebook();
        if (result?.error) {
          setError(`Error con Facebook: ${result.error}`);
          setLoading(false);
        } else {
          console.log('‚úÖ OAuth Facebook iniciado correctamente');
        }
      }
    } catch (error) {
      console.error('Error en OAuth desde registro:', error);
      setError(`Error: ${error.message}`);
      setLoading(false);
    }
  };

  // Componente de botones OAuth
  const OAuthButtons = () => (
    <div style={{ display: 'flex', gap: '10px', marginTop: '10px' }}>
      <button
        type="button"
        onClick={() => handleOAuthComplete('google')}
        disabled={loading}
        style={{
          flex: 1,
          padding: '12px',
          background: '#4285f4',
          color: '#fff',
          border: 'none',
          borderRadius: '8px',
          fontSize: '14px',
          fontWeight: 'bold',
          cursor: loading ? 'not-allowed' : 'pointer',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          gap: '8px',
          opacity: loading ? 0.7 : 1
        }}
      >
        <i className="fab fa-google"></i>
        Google
      </button>
      <button
        type="button"
        onClick={() => handleOAuthComplete('facebook')}
        disabled={loading}
        style={{
          flex: 1,
          padding: '12px',
          background: '#1877f2',
          color: '#fff',
          border: 'none',
          borderRadius: '8px',
          fontSize: '14px',
          fontWeight: 'bold',
          cursor: loading ? 'not-allowed' : 'pointer',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          gap: '8px',
          opacity: loading ? 0.7 : 1
        }}
      >
        <i className="fab fa-facebook-f"></i>
        Facebook
      </button>
    </div>
  );

  const handleDirectRegistration = async () => {
    setLoading(true);
    setError('');
    setMsg('Registrando directamente en la base de datos...');

    try {
      // Validaciones
      if (!form.nombre || !form.email || !form.password) {
        setError('Por favor completa todos los campos obligatorios');
        setLoading(false);
        return;
      }

      // Subir imagen si existe
      let avatarUrl = null;
      if (form.avatar_url && typeof form.avatar_url === 'object') {
        setMsg('Subiendo imagen de perfil...');
        avatarUrl = await uploadImage(form.avatar_url);
      }

      // Generar ID √∫nico para el usuario
      const userId = `user_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
      
      // Crear perfil directamente en la base de datos
      const perfilData = {
        id: userId,
        nombre: form.nombre.trim(),
        email: form.email.toLowerCase().trim(),
        edad: parseInt(form.edad) || null,
        peso: form.peso ? parseFloat(form.peso) : null,
        ciudad: form.ciudad?.trim() || null,
        pais: form.pais?.trim() || 'Espa√±a',
        posicion: form.posicion,
        frecuencia_juego: form.frecuencia_juego,
        avatar_url: avatarUrl,
        rol: form.rol,
        tipo_usuario: form.tipo_usuario,
        estado: 'pendiente_verificacion',
        created_at: new Date().toISOString(),
        updated_at: new Date().toISOString()
      };

      setMsg('Creando perfil de jugador...');
      const { error: perfilError } = await supabase
        .from('usuarios')
        .insert([perfilData]);

      if (perfilError) {
        console.error('‚ùå Error creando perfil directo:', perfilError);
        setError(`Error: ${perfilError.message}`);
        setLoading(false);
        return;
      }

      setMsg('¬°Usuario registrado! Te contactaremos para activar tu cuenta.');
      localStorage.removeItem('tempRegistroData');
      localStorage.removeItem('registroProgreso');
      // Asegurar intenci√≥n de navegaci√≥n a home
      localStorage.setItem('postLoginRedirect', '/home');
      
      setTimeout(() => {
        navigate('/home', { replace: true });
      }, 1500);

    } catch (error) {
      console.error('üí• Error en registro directo:', error);
      setError(`Error: ${error.message}`);
    } finally {
      setLoading(false);
    }
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    setLoading(true);
    setError('');
    setMsg('');

    // Asegurar redirecci√≥n post-login consistente
    localStorage.setItem('postLoginRedirect', '/home');
    localStorage.setItem('postLoginRedirectReason', 'signup-full');

    try {
      if (!form.nombre || !form.email || !form.password) {
        setError('Por favor completa todos los campos obligatorios');
        setLoading(false);
        return;
      }

      if (form.password !== form.confirmPassword) {
        setError('Las contrase√±as no coinciden');
        setLoading(false);
        return;
      }

      let avatarUrl = null;
      if (form.avatar_url && typeof form.avatar_url === 'object') {
        console.log('üì∏ Subiendo imagen de perfil...');
        setMsg('Subiendo imagen de perfil...');
        avatarUrl = await uploadImage(form.avatar_url);
        if (!avatarUrl) {
          console.warn('‚ö†Ô∏è No se pudo subir la imagen, continuando sin ella...');
        }
      }

      // REGISTRO DIRECTO CON BYPASS DE CAPTCHA
      console.log('ÔøΩ Registrando usuario directamente...');
      setMsg('Creando cuenta de usuario...');
      // Obtener token mock siempre
      const { status, provider } = getCaptchaProviderInfo();
      const authOptions = {
        email: form.email.toLowerCase().trim(),
        password: form.password,
        options: {
          data: {
            nombre: form.nombre.trim(),
            full_name: form.nombre.trim()
          }
        }
      };
      
      // BYPASS DEFINITIVO: NO ENVIAR captchaToken en absoluto
      // Si Supabase no recibe captchaToken, no validar√° captcha
      console.log('[CAPTCHA] üöÄ BYPASS DEFINITIVO: NO enviando captchaToken');
      console.log('[CAPTCHA] ÔøΩÔ∏è Supabase saltar√° validaci√≥n captcha autom√°ticamente');
      
      const { data: authData, error: authError } = await supabase.auth.signUp(authOptions);

      if (authError) {
        console.error('‚ùå Error en Auth:', authError);
        
        // Manejar errores espec√≠ficos
        if (authError.message?.includes('already registered') || 
           authError.message?.includes('User already registered')) {
          setError('Este email ya est√° registrado. Ve al login para iniciar sesi√≥n.');
          setTimeout(() => navigate('/', { replace: true }), 3000);
          return;
        } else if (authError.message?.includes('signup_disabled')) {
          setError('El registro est√° temporalmente deshabilitado. Intenta m√°s tarde.');
        } else if (authError.message?.toLowerCase().includes('captcha')) {
          console.warn('üõ°Ô∏è CAPTCHA bloque√≥ el registro. Usando bypass con Function...');
          setMsg('Verificaci√≥n bloqueada. Intentando crear cuenta de forma segura...');
          const bypass = await signupBypass({
            email: form.email.toLowerCase().trim(),
            password: form.password,
            nombre: form.nombre.trim()
          });
          if (!bypass.ok) {
            setError('Error de seguridad: ' + (bypass.error || 'No se pudo crear la cuenta. Intenta m√°s tarde.'));
            setLoading(false);
            return;
          }
          // Intentar iniciar sesi√≥n ahora que el usuario existe
          const { data: signInData2, error: signInErr2 } = await supabase.auth.signInWithPassword({
            email: form.email.toLowerCase().trim(),
            password: form.password
          });
          if (signInErr2) {
            console.warn('‚ö†Ô∏è No se pudo iniciar sesi√≥n tras bypass, redirigiendo a magic link...', signInErr2.message);
            if (bypass.redirectLink) {
              window.location.assign(bypass.redirectLink);
              return;
            }
            setError('Cuenta creada, pero no se pudo iniciar sesi√≥n autom√°ticamente. Ve al login.');
            setLoading(false);
            return;
          }
          session = signInData2.session;
          console.log('üîì Sesi√≥n iniciada v√≠a bypass function');
        } else {
          setError(`Error de registro: ${authError.message}`);
        }
        if (!session) {
          setLoading(false);
          return;
        }
      }

      // Si llegamos aqu√≠, el registro en Auth fue exitoso
      console.log('‚úÖ Usuario registrado en Auth:', authData.user?.email);
      console.log('üë§ Usuario ID:', authData.user?.id);

      // Asegurar sesi√≥n activa (Supabase puede no iniciar sesi√≥n si requiere confirmaci√≥n de email)
      let session = authData.session || null;
      if (!session) {
        console.log('üîê No hay sesi√≥n tras el signUp. Intentando iniciar sesi√≥n autom√°ticamente...');
        const { data: signInData, error: signInError } = await supabase.auth.signInWithPassword({
          email: form.email.toLowerCase().trim(),
          password: form.password
        });
        if (signInError) {
          console.warn('‚ö†Ô∏è No se pudo iniciar sesi√≥n autom√°ticamente:', signInError.message);
          const needsConfirm = signInError.message?.toLowerCase().includes('email') && signInError.message?.toLowerCase().includes('confirm');
          if (needsConfirm) {
            // Si auto-confirm est√° habilitado, simplemente omitir la verificaci√≥n
            if (cfg.autoConfirmSignup) {
              console.log('üè† Auto-confirm habilitado: omitiendo verificaci√≥n de email');
              setMsg('Cuenta creada exitosamente. Iniciando sesi√≥n...');
            }

            // Se√±ales y navegaci√≥n estable
            localStorage.setItem('registroCompleto', 'true');
            localStorage.setItem('authCompleted', 'true');
            setTimeout(() => ensureHomeNavigation(navigate, { target: '/home' }), 300);

            return;
          }
        } else {
          session = signInData.session;
          console.log('üîì Sesi√≥n iniciada autom√°ticamente');
        }
      }
      
      // Crear perfil en la base de datos
      setMsg('Completando perfil de jugador...');
      
      const perfilData = {
        id: authData.user.id,
        nombre: form.nombre.trim(),
        email: form.email.toLowerCase().trim(),
        edad: parseInt(form.edad) || null,
        peso: form.peso ? parseFloat(form.peso) : null,
        ciudad: form.ciudad?.trim() || null,
        pais: form.pais?.trim() || 'Espa√±a',
        posicion: form.posicion,
        frecuencia_juego: form.frecuencia_juego,
        avatar_url: avatarUrl,
        rol: form.rol || 'usuario',
        tipo_usuario: form.tipo_usuario || 'jugador',
        estado: 'activo',
        created_at: new Date().toISOString(),
        updated_at: new Date().toISOString()
      };

      console.log('üìù Datos del perfil a insertar:', perfilData);
      
      const { data: insertData, error: perfilError } = await supabase
        .from('usuarios')
        .insert([perfilData])
        .select();

      if (perfilError) {
        console.error('‚ùå Error creando perfil:', perfilError);
        setError(`Error creando perfil: ${perfilError.message}`);
        setLoading(false);
        return;
      }

      console.log('‚úÖ Perfil creado exitosamente:', insertData);
      console.log('üéâ REGISTRO COMPLETADO EXITOSAMENTE');
      
      setMsg('¬°Registro exitoso! Bienvenido a FutPro. Redirigiendo a tu dashboard...');
      
      // Limpiar datos temporales
      localStorage.removeItem('tempRegistroData');
      localStorage.removeItem('registroProgreso');
      
      // Calcular calificaci√≥n basada en frecuencia de juego
      const frecuencia = parseInt(form.frecuencia_juego);
      let calificacion = 50; // Base
      if (frecuencia >= 7) calificacion = 95;
      else if (frecuencia >= 6) calificacion = 90;
      else if (frecuencia >= 5) calificacion = 85;
      else if (frecuencia >= 4) calificacion = 75;
      else if (frecuencia >= 3) calificacion = 65;
      else if (frecuencia >= 2) calificacion = 55;
      
      // Guardar datos del usuario registrado
      localStorage.setItem('userRegistrado', JSON.stringify({
        id: authData.user.id,
        nombre: form.nombre,
        email: form.email,
        calificacion: calificacion,
        registrado: true,
        timestamp: new Date().toISOString()
      }));
      
      // Marcar que el registro est√° completo y forzar actualizaci√≥n del contexto
      localStorage.setItem('registroCompleto', 'true');
      localStorage.setItem('authCompleted', 'true');
      
      // Mensaje de √©xito y esperar un poco para que el contexto se actualice
      console.log('üéâ REGISTRO COMPLETADO - Preparando navegaci√≥n...');
      
      // Navegaci√≥n m√°s robusta con m√∫ltiples intentos
      const navigateToHome = () => {
        try {
          console.log('üîÑ Navegando a /home despu√©s del registro completo');
          navigate('/home', { replace: true });
        } catch (navError) {
          console.warn('‚ö†Ô∏è Error en navigate, intentando con window.location');
          window.location.href = '/home';
        }
      };
      
      // Intentar navegaci√≥n inmediata
      setTimeout(navigateToHome, 1000);
      
      // Fallback por si falla la primera navegaci√≥n
      setTimeout(() => {
        if (window.location.pathname !== '/home') {
          console.log('üîÑ Navegaci√≥n fallback ejecut√°ndose...');
          navigateToHome();
        }
      }, 3000);

    } catch (error) {
      console.error('üí• Error inesperado en registro:', error);
      setError(`Error inesperado: ${error.message}. Por favor intenta nuevamente.`);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div style={{
      minHeight: '100vh',
      background: `linear-gradient(135deg, ${black} 0%, #333 100%)`,
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      padding: '20px',
      fontFamily: 'Arial, sans-serif'
    }}>
      <div style={{
        background: darkCard,
        border: `2px solid ${gold}`,
        borderRadius: '20px',
        padding: '40px',
        width: '100%',
        maxWidth: '600px',
        boxShadow: `0 20px 60px rgba(0, 0, 0, 0.5)`
      }}>
        {/* Banner QA: auto-confirm activo */}
        {cfg.autoConfirmSignup && !hideAutoConfirmBanner && (
          <div style={{
            background: '#1e3a8a',
            color: '#fff',
            border: `1px solid ${gold}`,
            borderRadius: '8px',
            padding: '10px 12px',
            marginBottom: '16px',
            display: 'flex',
            justifyContent: 'space-between',
            alignItems: 'center',
            fontSize: '12px'
          }}>
            <span>Modo QA: la verificaci√≥n por email est√° desactivada (auto-confirm activo)</span>
            <button
              type="button"
              onClick={() => { localStorage.setItem('hideAutoConfirmBanner', 'true'); setHideAutoConfirmBanner(true); }}
              style={{
                background: 'transparent',
                color: gold,
                border: `1px solid ${gold}`,
                borderRadius: '6px',
                padding: '2px 8px',
                cursor: 'pointer'
              }}
            >Ocultar</button>
          </div>
        )}
        {/* Header */}
        <div style={{ textAlign: 'center', marginBottom: '30px' }}>
          <FutproLogo size={80} />
          <h1 style={{ color: gold, marginTop: '20px', marginBottom: '10px' }}>
            Registro Completo FutPro
          </h1>
          <p style={{ color: '#ccc', fontSize: '14px' }}>
            Paso {currentStep} de 3 - Completa tu perfil de jugador
          </p>
        </div>

        {/* Progress Bar */}
        <div style={{
          background: '#333',
          height: '6px',
          borderRadius: '3px',
          marginBottom: '30px',
          overflow: 'hidden'
        }}>
          <div style={{
            background: gold,
            height: '100%',
            width: `${(currentStep / 3) * 100}%`,
            transition: 'width 0.3s ease'
          }} />
        </div>

        {/* Mensajes */}
        {error && (
          <div style={{
            background: '#ff4444',
            color: '#fff',
            padding: '15px',
            borderRadius: '8px',
            marginBottom: '20px',
            textAlign: 'center',
            fontSize: '14px',
            fontWeight: 'bold'
          }}>
            ‚ùå {error}
            {error.includes('Demasiados intentos') && (
              <div style={{ marginTop: '10px' }}>
                <button
                  onClick={() => {
                    setError('');
                    handleDirectRegistration();
                  }}
                  style={{
                    background: '#ff6b35',
                    color: '#fff',
                    border: 'none',
                    padding: '8px 16px',
                    borderRadius: '4px',
                    fontSize: '12px',
                    cursor: 'pointer',
                    marginTop: '8px'
                  }}
                >
                  üöÄ Registro Directo (Sin verificaci√≥n email)
                </button>
              </div>
            )}
          </div>
        )}

        {msg && (
          <div style={{
            background: '#22c55e',
            color: '#fff',
            padding: '15px',
            borderRadius: '8px',
            marginBottom: '20px',
            textAlign: 'center',
            fontSize: '14px',
            fontWeight: 'bold'
          }}>
            ‚úÖ {msg}
          </div>
        )}

        {/* Mensaje adicional para el √∫ltimo paso */}
        {currentStep === 3 && (
          <div style={{
            background: '#1a365d',
            color: gold,
            padding: '15px',
            borderRadius: '8px',
            marginBottom: '20px',
            textAlign: 'center',
            fontSize: '14px',
            border: `1px solid ${gold}`
          }}>
            üèÜ ¬°√öltimo paso! Completa tu ubicaci√≥n y foto de perfil
          </div>
        )}

        <form onSubmit={handleSubmit}>
          {/* PASO 1: Informaci√≥n b√°sica */}
          {currentStep === 1 && (
            <div>
              <h2 style={{ color: gold, marginBottom: '20px', fontSize: '20px' }}>
                üìù Informaci√≥n B√°sica
              </h2>
              
              <div style={{ marginBottom: '20px' }}>
                <label style={{ color: gold, display: 'block', marginBottom: '8px' }}>
                  Nombre completo *
                </label>
                <input
                  type="text"
                  name="nombre"
                  value={form.nombre}
                  onChange={handleChange}
                  style={{
                    width: '100%',
                    padding: '12px',
                    border: `2px solid #444`,
                    borderRadius: '8px',
                    background: '#333',
                    color: '#fff',
                    fontSize: '16px'
                  }}
                  placeholder="Tu nombre completo"
                />
              </div>

              <div style={{ marginBottom: '20px' }}>
                <label style={{ color: gold, display: 'block', marginBottom: '8px' }}>
                  Email *
                </label>
                <input
                  type="email"
                  name="email"
                  value={form.email}
                  onChange={handleChange}
                  style={{
                    width: '100%',
                    padding: '12px',
                    border: `2px solid #444`,
                    borderRadius: '8px',
                    background: '#333',
                    color: '#fff',
                    fontSize: '16px'
                  }}
                  placeholder="tu@email.com"
                />
              </div>

              <div style={{ marginBottom: '20px' }}>
                <label style={{ color: gold, display: 'block', marginBottom: '8px' }}>
                  Contrase√±a *
                </label>
                <input
                  type="password"
                  name="password"
                  value={form.password}
                  onChange={handleChange}
                  style={{
                    width: '100%',
                    padding: '12px',
                    border: `2px solid #444`,
                    borderRadius: '8px',
                    background: '#333',
                    color: '#fff',
                    fontSize: '16px'
                  }}
                  placeholder="M√≠nimo 6 caracteres"
                />
              </div>

              <div style={{ marginBottom: '20px' }}>
                <label style={{ color: gold, display: 'block', marginBottom: '8px' }}>
                  Confirmar contrase√±a *
                </label>
                <input
                  type="password"
                  name="confirmPassword"
                  value={form.confirmPassword}
                  onChange={handleChange}
                  style={{
                    width: '100%',
                    padding: '12px',
                    border: `2px solid #444`,
                    borderRadius: '8px',
                    background: '#333',
                    color: '#fff',
                    fontSize: '16px'
                  }}
                  placeholder="Repite tu contrase√±a"
                />
              </div>

              <button
                type="button"
                onClick={nextStep}
                style={{
                  width: '100%',
                  padding: '15px',
                  background: gold,
                  color: black,
                  border: 'none',
                  borderRadius: '8px',
                  fontSize: '18px',
                  fontWeight: 'bold',
                  cursor: 'pointer'
                }}
              >
                Siguiente ‚Üí
              </button>
            </div>
          )}

          {/* PASO 2: Informaci√≥n deportiva */}
          {currentStep === 2 && (
            <div>
              <h2 style={{ color: gold, marginBottom: '20px', fontSize: '20px' }}>
                ‚öΩ Informaci√≥n Deportiva
              </h2>

              <div style={{ display: 'flex', gap: '10px', marginBottom: '20px' }}>
                <div style={{ flex: 1 }}>
                  <label style={{ color: gold, display: 'block', marginBottom: '8px' }}>
                    Edad
                  </label>
                  <input
                    type="number"
                    name="edad"
                    value={form.edad}
                    onChange={handleChange}
                    style={{
                      width: '100%',
                      padding: '12px',
                      border: `2px solid #444`,
                      borderRadius: '8px',
                      background: '#333',
                      color: '#fff',
                      fontSize: '16px'
                    }}
                    min="13"
                    max="60"
                  />
                </div>
                <div style={{ flex: 1 }}>
                  <label style={{ color: gold, display: 'block', marginBottom: '8px' }}>
                    Peso (kg)
                  </label>
                  <input
                    type="number"
                    name="peso"
                    value={form.peso}
                    onChange={handleChange}
                    style={{
                      width: '100%',
                      padding: '12px',
                      border: `2px solid #444`,
                      borderRadius: '8px',
                      background: '#333',
                      color: '#fff',
                      fontSize: '16px'
                    }}
                    placeholder="70"
                    min="30"
                    max="150"
                  />
                </div>
              </div>

              <div style={{ marginBottom: '20px' }}>
                <label style={{ color: gold, display: 'block', marginBottom: '8px' }}>
                  Posici√≥n preferida
                </label>
                <select
                  name="posicion"
                  value={form.posicion}
                  onChange={handleChange}
                  style={{
                    width: '100%',
                    padding: '12px',
                    border: `2px solid #444`,
                    borderRadius: '8px',
                    background: '#333',
                    color: '#fff',
                    fontSize: '16px'
                  }}
                >
                  <option value="Portero">ü•Ö Portero</option>
                  <option value="Defensa Central">üõ°Ô∏è Defensa Central</option>
                  <option value="Lateral Derecho">‚û°Ô∏è Lateral Derecho</option>
                  <option value="Lateral Izquierdo">‚¨ÖÔ∏è Lateral Izquierdo</option>
                  <option value="Libero">üîí Libero</option>
                  <option value="Pivote">‚öôÔ∏è Pivote</option>
                  <option value="Mediocentro">üéØ Mediocentro</option>
                  <option value="Mediocentro Ofensivo">üî• Mediocentro Ofensivo</option>
                  <option value="Extremo Derecho">üöÄ Extremo Derecho</option>
                  <option value="Extremo Izquierdo">‚ö° Extremo Izquierdo</option>
                  <option value="Media Punta">üíé Media Punta</option>
                  <option value="Delantero Centro">üéØ Delantero Centro</option>
                  <option value="Segundo Delantero">‚≠ê Segundo Delantero</option>
                </select>
              </div>

              <div style={{ marginBottom: '20px' }}>
                <label style={{ color: gold, display: 'block', marginBottom: '8px' }}>
                  ¬øCu√°ntos d√≠as juegas por semana? (Afecta tu calificaci√≥n)
                </label>
                <select
                  name="frecuencia_juego"
                  value={form.frecuencia_juego}
                  onChange={handleChange}
                  style={{
                    width: '100%',
                    padding: '12px',
                    border: `2px solid #444`,
                    borderRadius: '8px',
                    background: '#333',
                    color: '#fff',
                    fontSize: '16px'
                  }}
                >
                  <option value="1">üî• 1 d√≠a por semana (Casual)</option>
                  <option value="2">‚ö° 2 d√≠as por semana (Aficionado)</option>
                  <option value="3">üéØ 3 d√≠as por semana (Regular)</option>
                  <option value="4">ÔøΩ 4 d√≠as por semana (Dedicado)</option>
                  <option value="5">üèÜ 5 d√≠as por semana (Serio)</option>
                  <option value="6">‚≠ê 6 d√≠as por semana (Semi-Pro)</option>
                  <option value="7">üëë 7 d√≠as por semana (Profesional)</option>
                </select>
              </div>

              <div style={{ display: 'flex', gap: '10px' }}>
                <button
                  type="button"
                  onClick={prevStep}
                  style={{
                    flex: 1,
                    padding: '15px',
                    background: '#444',
                    color: '#fff',
                    border: 'none',
                    borderRadius: '8px',
                    fontSize: '16px',
                    cursor: 'pointer'
                  }}
                >
                  ‚Üê Anterior
                </button>
                <button
                  type="button"
                  onClick={nextStep}
                  style={{
                    flex: 1,
                    padding: '15px',
                    background: gold,
                    color: black,
                    border: 'none',
                    borderRadius: '8px',
                    fontSize: '16px',
                    fontWeight: 'bold',
                    cursor: 'pointer'
                  }}
                >
                  Siguiente ‚Üí
                </button>
              </div>
            </div>
          )}

          {/* PASO 3: Foto y ubicaci√≥n */}
          {currentStep === 3 && (
            <div>
              <h2 style={{ color: gold, marginBottom: '20px', fontSize: '20px' }}>
                üì∏ Foto y Ubicaci√≥n
              </h2>

              <div style={{ marginBottom: '20px' }}>
                <label style={{ color: gold, display: 'block', marginBottom: '8px' }}>
                  Foto de perfil (opcional)
                </label>
                <input
                  type="file"
                  ref={fileInputRef}
                  onChange={handleImageChange}
                  accept="image/*"
                  style={{ display: 'none' }}
                />
                <button
                  type="button"
                  onClick={() => fileInputRef.current?.click()}
                  style={{
                    width: '100%',
                    padding: '15px',
                    background: '#444',
                    color: '#fff',
                    border: `2px dashed ${gold}`,
                    borderRadius: '8px',
                    fontSize: '16px',
                    cursor: 'pointer',
                    marginBottom: '10px'
                  }}
                >
                  üì∑ Seleccionar imagen
                </button>
                
                {previewImage && (
                  <div style={{ textAlign: 'center', marginBottom: '10px' }}>
                    <p style={{ color: gold, marginBottom: '10px' }}>Preview</p>
                    <img
                      src={previewImage}
                      alt="Vista previa"
                      style={{
                        width: '120px',
                        height: '120px',
                        borderRadius: '50%',
                        objectFit: 'cover',
                        border: `3px solid ${gold}`
                      }}
                    />
                  </div>
                )}
              </div>

              <div style={{ display: 'flex', gap: '10px', marginBottom: '20px' }}>
                <div style={{ flex: 1 }}>
                  <label style={{ color: gold, display: 'block', marginBottom: '8px' }}>
                    Ciudad
                  </label>
                  <input
                    type="text"
                    name="ciudad"
                    value={form.ciudad}
                    onChange={handleChange}
                    style={{
                      width: '100%',
                      padding: '12px',
                      border: `2px solid #444`,
                      borderRadius: '8px',
                      background: '#333',
                      color: '#fff',
                      fontSize: '16px'
                    }}
                    placeholder="Tu ciudad"
                  />
                </div>
                <div style={{ flex: 1 }}>
                  <label style={{ color: gold, display: 'block', marginBottom: '8px' }}>
                    Pa√≠s
                  </label>
                  <input
                    type="text"
                    name="pais"
                    value={form.pais}
                    onChange={handleChange}
                    style={{
                      width: '100%',
                      padding: '12px',
                      border: `2px solid #444`,
                      borderRadius: '8px',
                      background: '#333',
                      color: '#fff',
                      fontSize: '16px'
                    }}
                  />
                </div>
              </div>

              <div style={{ display: 'flex', gap: '10px' }}>
                <button
                  type="button"
                  onClick={prevStep}
                  style={{
                    flex: 1,
                    padding: '15px',
                    background: '#444',
                    color: '#fff',
                    border: 'none',
                    borderRadius: '8px',
                    fontSize: '16px',
                    cursor: 'pointer'
                  }}
                >
                  ‚Üê Anterior
                </button>
                <button
                  type="submit"
                  disabled={loading}
                  style={{
                    flex: 2,
                    padding: '15px',
                    background: loading ? '#666' : gold,
                    color: black,
                    border: 'none',
                    borderRadius: '8px',
                    fontSize: '18px',
                    fontWeight: 'bold',
                    cursor: loading ? 'not-allowed' : 'pointer'
                  }}
                >
                  {loading ? 'Registrando...' : 'Completar Registro ‚úÖ'}
                </button>
              </div>

              {/* Separador con opciones r√°pidas OAuth */}
              <div style={{ 
                margin: '30px 0 20px 0', 
                textAlign: 'center',
                position: 'relative'
              }}>
                <div style={{
                  height: '1px',
                  background: '#444',
                  margin: '0 auto',
                  position: 'relative'
                }}>
                  <span style={{
                    background: darkCard,
                    color: '#ccc',
                    padding: '0 15px',
                    fontSize: '14px',
                    position: 'absolute',
                    left: '50%',
                    top: '-8px',
                    transform: 'translateX(-50%)'
                  }}>
                    o termina r√°pido con
                  </span>
                </div>
              </div>

              {/* Botones OAuth finales */}
              <OAuthButtons />
            </div>
          )}
        </form>

        {/* Volver al login */}
        <div style={{ textAlign: 'center', marginTop: '20px' }}>
          <p style={{ color: '#ccc', fontSize: '14px' }}>
            ¬øYa tienes cuenta?{' '}
            <span
              onClick={() => navigate('/')}
              style={{
                color: gold,
                cursor: 'pointer',
                textDecoration: 'underline'
              }}
            >
              Inicia sesi√≥n
            </span>
          </p>
        </div>
      </div>
    </div>
  );
}