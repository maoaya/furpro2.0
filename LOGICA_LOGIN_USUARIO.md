# üîê L√≥gica de LOGIN y CREACI√ìN DE USUARIO en FutPro

## üìä Resumen Ejecutivo

FutPro implementa un **sistema de autenticaci√≥n dual** con tres m√©todos de registro/login:

1. **OAuth Social** (Google/Facebook) ‚Üí Inmediato
2. **Email/Password B√°sico** ‚Üí Con bypass anti-CAPTCHA 
3. **Registro Completo** ‚Üí Sistema de 5 pasos con perfil detallado

---

## üö™ Punto de Entrada: `LoginRegisterForm.jsx`

### **Interfaz Principal**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ          ‚öΩ FutPro                   ‚îÇ
‚îÇ     Plataforma de F√∫tbol            ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  üåê Continuar con Google            ‚îÇ
‚îÇ  üìò Continuar con Facebook          ‚îÇ
‚îÇ         ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ o ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ           ‚îÇ
‚îÇ    üìß Usar Email y Contrase√±a       ‚îÇ
‚îÇ    üë§ Crear Usuario (Completo)      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### **Estados de la Interfaz**
- **Por defecto**: Botones sociales + opciones b√°sicas
- **Email activado**: Formulario email/password + toggle login/registro
- **Siempre visible**: Bot√≥n "Crear Usuario" (redirige a registro completo)

---

## üîÑ Flujo de Autenticaci√≥n Social (OAuth)

### **Google/Facebook Login**
```javascript
const handleLoginSocial = async (provider) => {
  const { data, error } = await supabase.auth.signInWithOAuth({
    provider: provider,
    options: {
      redirectTo: `${window.location.origin}/auth/callback`
    }
  });
  
  if (!error) {
    setSuccess(`Redirigiendo a ${provider}...`);
    // Redirecci√≥n autom√°tica por Supabase
  }
};
```

### **Flujo OAuth Completo**
1. **Click en bot√≥n social** ‚Üí `handleLoginSocial('google')`
2. **Redirecci√≥n a provider** ‚Üí Google/Facebook OAuth
3. **Callback autom√°tico** ‚Üí `/auth/callback` (manejado por router)
4. **AuthContext detecta sesi√≥n** ‚Üí Usuario autenticado
5. **Redirecci√≥n final** ‚Üí `/home`

---

## üìß Flujo de Email/Password

### **Modo Login (Existente)**
```javascript
const handleLogin = async (e) => {
  const { data, error } = await supabase.auth.signInWithPassword({
    email,
    password,
  });
  
  if (!error) {
    setSuccess('¬°Ingreso exitoso! Redirigiendo...');
    // Redirecci√≥n ultra-agresiva con m√∫ltiples fallbacks
    setTimeout(() => navigate('/home'), 500);
  }
};
```

### **Modo Registro (Anti-CAPTCHA)**
```javascript
const handleRegister = async (e) => {
  // üöÄ BYPASS ANTI-CAPTCHA usando Netlify Function
  const response = await fetch('/.netlify/functions/signup-bypass', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      email: email.toLowerCase().trim(),
      password,
      nombre: email.split('@')[0]
    })
  });
  
  if (response.ok) {
    // Registro exitoso ‚Üí /home
  } else {
    // INTERCEPCI√ìN NUCLEAR: Cambiar a modo login autom√°ticamente
    setIsRegister(false);
    setSuccess('üéØ ¬°Email detectado! Cambiando a modo de ingreso autom√°ticamente...');
  }
};
```

### **Sistema Anti-502 Inteligente**
- **Si el registro falla** ‚Üí Asume que el usuario ya existe
- **Cambio autom√°tico** ‚Üí De "Registrarse" a "Ingresar"
- **UX fluida** ‚Üí Sin errores confusos, solo orientaci√≥n

---

## üõ°Ô∏è Netlify Function: `signup-bypass.js`

### **Prop√≥sito**
Evitar errores 502 en registro directo usando **Service Role Key**

### **L√≥gica**
```javascript
exports.handler = async (event) => {
  const { email, password, nombre } = JSON.parse(event.body);
  
  // Usar Service Role para bypass CAPTCHA
  const { data, error } = await supabaseAdmin.auth.admin.createUser({
    email,
    password,
    email_confirm: true, // ‚úÖ Confirma autom√°ticamente
    user_metadata: { nombre }
  });
  
  return {
    statusCode: error ? 400 : 200,
    body: JSON.stringify(error ? { error } : { user: data.user })
  };
};
```

---

## üéØ Registro Completo: `RegistroNuevo.jsx`

### **Sistema de 5 Pasos**
```
Paso 1: Credenciales      ‚Üí email, password, confirmPassword
Paso 2: Datos Personales  ‚Üí nombre, apellido, edad, tel√©fono, pa√≠s, ubicaci√≥n
Paso 3: Info Futbol√≠stica ‚Üí posici√≥n, experiencia, equipoFavorito, peso
Paso 4: Disponibilidad    ‚Üí horarios, frecuencia de juego
Paso 5: Foto de Perfil    ‚Üí imagen upload + preview
```

### **Caracter√≠sticas Avanzadas**
- ‚úÖ **Auto-guardado** cada 30 segundos
- ‚úÖ **Validaci√≥n por paso** con mensajes espec√≠ficos
- ‚úÖ **Preview de imagen** en tiempo real
- ‚úÖ **Navegaci√≥n fluida** entre pasos
- ‚úÖ **Upload a Supabase Storage** para fotos

### **Flujo de Creaci√≥n Completa**
```javascript
const completarRegistro = async () => {
  // 1. Crear cuenta en Supabase Auth
  const { data: authData, error: authError } = await supabase.auth.signUp({
    email: formData.email,
    password: formData.password,
    options: {
      data: {
        full_name: `${formData.nombre} ${formData.apellido}`,
        display_name: formData.nombre
      }
    }
  });
  
  // 2. Si hay usuario, subir foto y crear perfil completo
  if (authData.user) {
    let fotoUrl = null;
    
    // Subir foto si existe
    if (imagenPerfil) {
      const fileName = `${authData.user.id}_${Date.now()}.jpg`;
      const { data: uploadData } = await supabase.storage
        .from('avatars')
        .upload(fileName, imagenPerfil);
      
      if (uploadData) {
        const { data: urlData } = supabase.storage
          .from('avatars')
          .getPublicUrl(uploadData.path);
        fotoUrl = urlData.publicUrl;
      }
    }
    
    // 3. Crear perfil en tabla usuarios
    const perfilCompleto = {
      id: authData.user.id,
      email: formData.email,
      nombre: formData.nombre,
      apellido: formData.apellido,
      // ... todos los campos del formulario
      foto_url: fotoUrl,
      created_at: new Date().toISOString()
    };
    
    await supabase.from('usuarios').insert([perfilCompleto]);
    
    // 4. Redirecci√≥n a card de perfil
    navigate('/perfil-card', { 
      state: { 
        perfilData: perfilCompleto,
        fromRegistration: true 
      } 
    });
  }
};
```

---

## üß† AuthContext: Gesti√≥n de Estado

### **Inicializaci√≥n**
```javascript
useEffect(() => {
  const initAuth = async () => {
    // 1. Verificar localStorage para indicaciones
    const authCompleted = localStorage.getItem('authCompleted') === 'true';
    const loginSuccess = localStorage.getItem('loginSuccess') === 'true';
    
    // 2. Obtener sesi√≥n actual de Supabase
    const { data: { session } } = await supabase.auth.getSession();
    
    if (session?.user) {
      setUser(session.user);
      
      // 3. Cargar perfil desde tabla usuarios
      const { data: userData } = await supabase
        .from('usuarios')
        .select('*')
        .eq('id', session.user.id)
        .single();
      
      if (userData) {
        setRole(userData.rol || 'player');
        setUserProfile(userData);
      }
    }
  };
}, []);
```

### **Auth State Changes**
```javascript
supabase.auth.onAuthStateChange(async (event, session) => {
  console.log('üîÑ Cambio en autenticaci√≥n:', event);
  
  if (session?.user) {
    setUser(session.user);
    
    // Verificar datos pendientes del registro completo
    const pendingData = localStorage.getItem('pendingProfileData');
    if (pendingData) {
      const profileData = JSON.parse(pendingData);
      
      // Crear perfil con datos pendientes
      await supabase.from('usuarios').insert([{
        id: session.user.id,
        email: session.user.email,
        ...profileData
      }]);
      
      localStorage.removeItem('pendingProfileData');
    }
  }
});
```

---

## üìä Tipos de Usuario y Estados

### **Estados de Autenticaci√≥n**
```
guest        ‚Üí No autenticado
authenticating ‚Üí Proceso de login en curso
authenticated  ‚Üí Sesi√≥n v√°lida
profile_complete ‚Üí Perfil completo en BD
profile_pending  ‚Üí Auth exitoso, perfil incompleto
```

### **Roles de Usuario**
```
guest   ‚Üí Visitante sin cuenta
player  ‚Üí Usuario jugador est√°ndar
admin   ‚Üí Administrador del sistema
coach   ‚Üí Entrenador de equipo
owner   ‚Üí Propietario de equipo
```

---

## üóÑÔ∏è Estructura de Base de Datos

### **Tabla `usuarios`**
```sql
CREATE TABLE usuarios (
  id UUID PRIMARY KEY,           -- Supabase Auth User ID
  email VARCHAR NOT NULL,        -- Email de autenticaci√≥n
  nombre VARCHAR,                -- Nombre real
  apellido VARCHAR,              -- Apellido
  edad INTEGER,                  -- Edad del jugador
  telefono VARCHAR,              -- Tel√©fono de contacto
  pais VARCHAR DEFAULT 'M√©xico', -- Pa√≠s de residencia
  ubicacion VARCHAR,             -- Ciudad/ubicaci√≥n
  posicion VARCHAR,              -- Posici√≥n futbol√≠stica
  experiencia VARCHAR,           -- Nivel de experiencia
  equipoFavorito VARCHAR,        -- Equipo favorito
  peso VARCHAR,                  -- Peso del jugador
  disponibilidad VARCHAR,        -- Disponibilidad general
  vecesJuegaPorSemana VARCHAR,   -- Frecuencia de juego
  horariosPreferidos VARCHAR,    -- Horarios preferidos
  foto_url VARCHAR,              -- URL de foto de perfil
  rol VARCHAR DEFAULT 'player',  -- Rol del usuario
  equipoId UUID,                 -- ID del equipo actual
  created_at TIMESTAMP,          -- Fecha de creaci√≥n
  updated_at TIMESTAMP           -- √öltima actualizaci√≥n
);
```

---

## üîÄ Flujos de Redirecci√≥n

### **Matriz de Redirecci√≥n**
```
OAuth Success     ‚Üí /home
Email Login       ‚Üí /home (con m√∫ltiples fallbacks)
Email Register    ‚Üí /home (bypass exitoso) | Modo Login (bypass falla)
Registro Completo ‚Üí /perfil-card (con datos) ‚Üí /home
Error General     ‚Üí Mantiene en /login con mensaje
```

### **Redirecci√≥n Ultra-Agresiva**
```javascript
// Patr√≥n usado en login exitoso
setTimeout(() => {
  try {
    navigate('/home');
  } catch (err) {
    window.location.href = '/home';
  }
  // Fallback definitivo
  setTimeout(() => {
    if (window.location.pathname !== '/home') {
      window.location.href = '/home';
    }
  }, 1000);
}, 500);
```

---

## üé® Card de Perfil y Scoring

### **Sistema de Puntuaci√≥n**
Despu√©s del registro completo, se calcula un score de 0-100 basado en:
- **Completitud del perfil** (40 puntos)
- **Informaci√≥n futbol√≠stica** (35 puntos)  
- **Disponibilidad clara** (25 puntos)

### **Categor√≠as por Score**
```
90-100: ‚≠ê ELITE     ‚Üí "Perfil Excepcional"
80-89:  üî• PRO      ‚Üí "Jugador Destacado"  
70-79:  üí™ S√ìLIDO   ‚Üí "Buen Jugador"
60-69:  ‚ö° PROMESA  ‚Üí "En Desarrollo"
<60:    üå± NOVATO   ‚Üí "Iniciando Camino"
```

---

## üõ°Ô∏è Seguridad y Manejo de Errores

### **Validaciones Implementadas**
- ‚úÖ **Email √∫nico** (manejado por Supabase)
- ‚úÖ **Contrase√±a m√≠nima** (6 caracteres)
- ‚úÖ **Edad v√°lida** (16-60 a√±os)
- ‚úÖ **Campos obligatorios** por paso
- ‚úÖ **Upload seguro** de im√°genes

### **Manejo de Errores**
- **502 en registro** ‚Üí Bypass autom√°tico con funci√≥n serverless
- **OAuth fallos** ‚Üí Mensajes espec√≠ficos por provider
- **Duplicados** ‚Üí Cambio inteligente a modo login
- **Validaci√≥n** ‚Üí Mensajes contextuales por campo

---

## üöÄ Optimizaciones y UX

### **Performance**
- **Auto-guardado** cada 30 segundos
- **Lazy loading** de componentes
- **Compresi√≥n de im√°genes** antes de upload
- **Cache de datos** en localStorage

### **Experiencia de Usuario**
- **Progreso visual** en registro de 5 pasos
- **Animaciones fluidas** entre pasos
- **Feedback inmediato** en validaciones
- **Recuperaci√≥n de sesi√≥n** autom√°tica
- **Modo offline** para auto-guardado

---

## üìã Pr√≥ximos Pasos T√©cnicos

1. **Implementar recuperaci√≥n de contrase√±a**
2. **A√±adir verificaci√≥n de email opcional**
3. **Sistema de invitaciones por referido**
4. **Integraci√≥n con redes sociales adicionales**
5. **Modo offline completo para registro**

---

> **‚úÖ Estado Actual**: Sistema completamente funcional en producci√≥n  
> **üåê URL**: https://futpro.vip  
> **üìä Deployment**: Netlify con funciones serverless activas
